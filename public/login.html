<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Milonga&family=Roboto&display=swap" rel="stylesheet">
    <!--<link rel="stylesheet" href="css/style.css">-->
	<script src="https://accounts.google.com/gsi/client" async></script>

    <title>Pandemon Login</title>

	<script>
	function loadContext ()
	{
	}


	// Credential response handler function
	function handleCredentialResponse (response)
	{
		let host = location.protocol.concat("//").concat(window.location.host);
		let path = window.location.pathname;
		path = path.replace("public/login.html", "");
		path = path + "api/auth_init.php";


		let value = localStorage.getItem("pandemon/name");
		console.log ("test: " + value)


		// Post JWT token to server-side
		fetch(path, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ request_type:'user_auth', credential: response.credential }),
			})
		.then(response => response.json())
		.then(data => {
			if(data.status === 1) {
				let responsePayload = data.pdata;

				if (value === null)
				{
					localStorage.setItem("pandemon/name", responsePayload.name);
				}

				// Display the user account data
				let profileHTML = '<h3><a href="javascript:void(0);" onclick="signOut(' +
						responsePayload.sub +
						');">Sign out</a></h3>';

				//profileHTML += '<img src="'+responsePayload.picture+'"/><p><b>Auth ID: </b>'+responsePayload.sub+'</p><p><b>Name: </b>'+responsePayload.name+'</p><p><b>Email: </b>'+responsePayload.email+'</p>';
				profileHTML += '<p><b>Auth ID: </b>' +
						responsePayload.sub +
						'</p><p><b>Name: </b>' +
						responsePayload.name +
						'</p><p><b>Email: </b>' +
						responsePayload.email +
						'</p>';
				document.getElementsByClassName("pro-data")[0].innerHTML = profileHTML;
				document.querySelector(".pro-data").classList.remove("hidden");

			}
		})
		.catch(console.error);
	}

	// Sign out the user
	function signOut (authID)
	{
		document.getElementsByClassName("pro-data")[0].innerHTML = '';
		document.querySelector("#btnWrap").classList.remove("hidden");
		document.querySelector(".pro-data").classList.add("hidden");
	}
	</script>

</head>
<body onload="loadContext();">
<main id="main-holder">
	<h1 id="login_header">Login</h1>

	<div id="g_id_onload"
		 data-client_id="407409119433-dvve62sdm0ju24p6sgojo79g0fhn0mqi.apps.googleusercontent.com"
		 data-context="signin"
		 data-ux_mode="popup"
		 data-callback="handleCredentialResponse"
		 data-auto_prompt="false">
	</div>

	<div class="g_id_signin"
		 data-type="standard"
		 data-shape="rectangular"
		 data-theme="outline"
		 data-text="signin_with"
		 data-size="large"
		 data-logo_alignment="left">
	</div>

	<!-- Display the user's profile info -->
	<div id="login_info" class="pro-data hidden"></div>


</main>
</body>
</html>